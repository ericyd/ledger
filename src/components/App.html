<div id='main' class='wrapper'>
  {{#if auth}}
    <button on:click="handleLogOut()" class="btn--secondary">Log out</button>
    <UserSummary balance={{balance}}
      transactions={{transactions}}
      name={{name}}/>
  {{else}}
    <!--note: svelte requires this parameter to be consistently named 'event'-->
    <LoginSignup on:submit="handleAuth(event)"/>
  {{/if}}
</div>


<script>
  import LoginSignup from './LoginSignup';
  import UserSummary from './UserSummary';
  const axios = require('axios');

  export default {
    data() {
      return {
        auth: localStorage.getItem('auth'),
        balance: 0,
        transactions: [],
        name: '',
        err: null
      }
    },
    components: {
      UserSummary,
      LoginSignup
    },
    methods: {
      handleLogOut() {
        this.set({auth: false});
        localStorage.removeItem('auth');
      },
      handleAuth(event) {
        this.set({
          balance: event.balance,
          transactions: event.transactions,
          name: event.name,
          auth: event.id
        });
        localStorage.setItem('auth', event.id);
      }
    },
    oncreate() {
      // if authenticated, populate user data
      if (this.get('auth')) {
        axios.get(`/users/${this.get('auth')}`)
        .then(userRes => {
          this.set({
            name: userRes.data.name,
            balance: userRes.data.balance
          })
          // once received user data, get transactions
          return axios.get(`/transactions/${this.get('auth')}`);
        })
        .then(transactionRes => {
          this.set({
            transactions: transactionRes.data.transactions
          })
        })
        .catch(err => {
          this.set({err: err})
        })
      }
    }
  }
</script>